# Pulsar 消息传输

Pulsar 建立在 发布-订阅 模式上，在这种模式下，生产者将消息发布到主题。消费者订阅这些主题，处理传入的消息，并在处理完成后发送确认。

创建订阅后，即使消费者断开连接，Pulsar 也会保留所有消息。仅当使用者确认成功处理了这些消息时，才会丢弃保留的消息。



## 消息格式

- `Value / data payload` 消息中的实际数据
- `Key` 消息可选地用键标记，这对于诸如主题压缩之类的很有用。
- `Properties` 用户定义的键值对
- `Producer name` 生产者的名称。如果未指定生产者名称，则使用默认名称。
- `Sequence ID` 每个Pulsar消息在其主题上都属于有序序列。消息的序列ID是其在该序列中的顺序。
- `Publish time` 消息发布的时间戳。时间戳由生产者自动应用。
- `Event time` 消费者在处理消息时附加时间戳。如果未设置任何值，则该值为0。
- `TypedMessageBuilder` 它用于构造消息。可以使用 TypedMessageBuilder 设置消息属性，例如消息密钥，消息值。 设置 TypedMessageBuilder 时，请将密钥设置为字符串。如果将密钥设置为其他类型（例如，AVRO对象），则密钥将以字节发送，并且很难将AVRO对象恢复给使用者。

> 更多格式内容，参考：[binary protocol](https://pulsar.apache.org/docs/en/develop-binary-protocol)



## 生产者 

生产者连接到主题，并将消息发给 broker，broker 会处理消息。



#### 发送模式

生产者将消息同步（同步）或异步（异步）发送给 brokers。

- 同步发送：发送每条消息后，生产者都会等待 broker 的确认。如果未收到确认，则生产者将发送操作视为失败。
- 异步发送：生产者将消息放入阻塞队列并立即返回。客户端库在后台将消息发送到代理。如果队列已满（您可以配置最大大小），则在调用API时，生产者将被阻塞或立即失败，具体取决于传递给生产者的参数。



#### 压缩

生产者可以对消息进行压缩，支持的压缩类型：

- [LZ4](https://github.com/lz4/lz4)
- [ZLIB](https://zlib.net/)
- [ZSTD](https://facebook.github.io/zstd/)
- [SNAPPY](https://google.github.io/snappy/)



#### 批处理 

启用批处理后，生产者将在单个请求中累积并发送一批消息。批处理大小由最大消息数和最大发布延迟定义。因此，待办事项的大小表示批处理的总数而不是消息的总数。

在Pulsar中，批次被跟踪并存储为单个单位，而不是单个消息。消费者将一批消息分解为单独的消息。但是，即使启用了批处理，调度的消息（通过 liverAt  或 deliverAfter 参数配置）也总是作为单独的消息发送。

通常，当消费者确认其所有消息时，将确认该批次。这意味着意外的故障，否定的确认或确认超时可能导致重新发送一批中的所有消息，即使某些消息已被确认也是如此。

为避免将已确认的消息批量重新分发给消费者，自 Pulsar 2.6.0 起，Pulsar 引入了批处理索引确认。启用批处理索引确认后，消费者将筛选出已确认的批处理索引，并将批处理索引确认请求发送给 broker。borker 维护批次索引确认状态，并跟踪每个批次索引的确认状态，以避免将已确认的消息发送给使用者。确认批处理消息的所有索引后，该批处理消息将被删除。

默认情况下，批次索引确认是禁用的（batchIndexAcknowledgeEnable = false）。您可以通过在 broker 上将 `batchIndexAcknowledgeEnable` 参数设置为 true 来启用批处理索引确认。**启用批处理索引确认会导致更多的内存开销**。



#### 分块

启用分块时：

- 批处理和分块不能同时启用。要启用分块，必须预先禁用批处理。
- 仅持久性主题支持块。
- 仅排他和故障转移订阅模式支持分块。























